{% extends "base.html" %}
{% block content %}

<div class="container">
    <h3 class="fw-bold text-primary mb-4">Attendance Records</h3>

    <!-- ================= FILTER ================= -->
    <form method="GET" class="row g-3 mb-4">

        {% if admin_branch == "CSE" %}
        <div class="col-md-3">
            <label class="fw-bold">CSE Branch</label>
            <select name="sub_branch" class="form-select" onchange="this.form.submit()">
                <option value="">Select</option>
                <option value="CSE (Network)" {% if sub_branch=="CSE (Network)" %}selected{% endif %}>
                    CSE (Network)
                </option>
                <option value="CSE (Cyber Security)" {% if sub_branch=="CSE (Cyber Security)" %}selected{% endif %}>
                    CSE (Cyber Security)
                </option>
            </select>
        </div>
        {% endif %}

        <div class="col-md-2">
            <label class="fw-bold">Semester</label>
            <select name="semester" class="form-select" onchange="this.form.submit()">
                <option value="">Select</option>
                {% for i in range(1,9) %}
                <option value="{{ i }}" {% if semester==i|string %}selected{% endif %}>
                    {{ i }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="fw-bold">Subject</label>
            <select name="subject_id" class="form-select" onchange="this.form.submit()">
                <option value="">All Subjects</option>
                {% for s in subjects %}
                <option value="{{ s.id }}" {% if subject_id==s.id|string %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="fw-bold">Date</label>
            <input type="date" name="date" class="form-control" value="{{ date }}" onchange="this.form.submit()">

        </div>

    </form>

    <!-- ================= DOWNLOAD BUTTONS ================= -->
    <div class="mb-4 d-flex gap-2 align-items-end">

        <!-- DOWNLOAD SELECTED DATE -->
        <form method="GET" action="{{ url_for('export_attendance_excel') }}">
            <input type="hidden" name="sub_branch" value="{{ sub_branch }}">
            <input type="hidden" name="semester" value="{{ semester }}">
            <input type="hidden" name="subject_id" value="{{ subject_id }}">
            <input type="hidden" name="date" value="{{ date }}">

            <button type="submit" class="btn btn-primary px-4" style="background-color:#0b5ed7;border-color:#0b5ed7;" {%
                if not date %}disabled{% endif %}>
                Download Selected Date
            </button>
        </form>

        <!-- DOWNLOAD ALL DATES -->
        <form method="GET" action="{{ url_for('export_attendance_excel') }}">
            <input type="hidden" name="sub_branch" value="{{ sub_branch }}">
            <input type="hidden" name="semester" value="{{ semester }}">
            <input type="hidden" name="subject_id" value="{{ subject_id }}">
            <input type="hidden" name="all_dates" value="1">

            <button type="submit" class="btn btn-success px-4">
                Download All Dates
            </button>
        </form>

    </div>


    <!-- ================= TABLE ================= -->
    {% if records %}
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Roll</th>
                <th>Reg No</th>
                <th>Subject</th>
                <th>Date</th>
                <th>Status</th>
                <th>%</th>
            </tr>
        </thead>
        <tbody>
            {% for r in records %}
            <tr>
                <td>{{ r.name }}</td>
                <td>{{ r.roll_no }}</td>
                <td>{{ r.registration_no }}</td>
                <td>{{ r.subject }}</td>
                <td>{{ r.date }}</td>
                <td>{{ r.status }}</td>
                <td class="{% if r['percentage'] >= 75 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    {{ r['percentage'] }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No records found.</p>
    {% endif %}

</div>

{% endblock %}